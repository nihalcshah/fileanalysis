<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Browser and Chat Interface</title>

    <link
      href="https://fonts.googleapis.com/css2?family=SF+Pro:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Add these lines in the <head> section -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"> -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.4.0/flowbite.min.css"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='styles.css') }}"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='output.css') }}"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #0C001A;
        background-image: url('/static/background.png');
        background-size: cover; /* Ensures the image covers the entire background */
        overflow: hidden; /* Clips any overflow */
      }

      .file-browser-drawer {
        transition: transform 0.3s ease, opacity 0.3s ease; /* Add opacity transition */
        transform: translateX(-100%); /* Start hidden */
        opacity: 0; /* Start fully transparent */
        pointer-events: none; /* Prevent interaction when hidden */
      }

      .file-browser-drawer.visible {
        transform: translateX(0); /* Slide in */
        opacity: 1; /* Fully opaque */
        pointer-events: auto; /* Allow interaction when visible */
      }
    </style>
  </head>
  <body>
    <div class="w-full">
      <div class="flex gap-4 h-screen">
        <div id="fileBrowserToggleOut" class="group h-full bg-[#0C001A] border-purple-900 border-r p-2">
            <button class="cursor-pointer text-2xl group-hover:bg-indigo-950 p-2 rounded-xl hover:bg-indigo-950 flex items-center text-purple-500 justify-center">
              ÙÄèö
            </button>
        </div>
        <div id="fileBrowserDrawer" class="file-browser-drawer w-1/3 hidden bg-[#0C001A] border-purple-900 border-r text-white">
          <div class="fixed top-0 right-0 z-40 p-3">
            <button id="fileBrowserToggleIn" class="cursor-pointer text-2xl p-2 rounded-xl hover:bg-indigo-950 flex items-center text-purple-500 justify-center">ÙÄèö</button>
          </div>
          <div class="fixed top-0 left-0 z-40 h-full p-4 overflow-y-auto" aria-hidden="true" data-drawer="{animation: 'slide', duration: 300}">
            <div class="h-full p-4 overflow-y-auto">
              <h4 class="font-bold text-xl text-white mb-4">File Browser</h4>
              <div class="mt-4 p-4 border-2 border-purple-800 rounded-lg hidden" id="filePreview">
                <h5 class="font-semibold text-purple-400 mb-2">File Preview</h5>
                <div id="previewContent" class="text-sm text-gray-300 break-words"></div>
              </div>
              <div class="my-3">
                <div class="flex items-center bg-transparent px-3 gap-2 rounded-lg border-2 border-purple-500 focus-within:border-purple-400">
                  <div class="text-lg text-purple-500">ÙÄä´</div>
                  <input type="text" class="p-2 w-full bg-transparent border-none focus:outline-none focus:ring-0 focus:border-transparent text-white placeholder-purple-300" id="searchInput" placeholder="Search files..." />
                </div>
              </div>
              <div class="file-list space-y-2" id="fileList"></div>
              
            </div>
          </div>
        </div>
        <div class="w-full mx-12 rounded-lg border-2 border-purple-800 p-6 bg-[#0C001A] m-auto text-white">
          <h4 class="font-bold text-2xl text-purple-500">Chat Interface</h4>
          <div class="h-[calc(100vh-350px)] overflow-y-auto p-4 my-4  rounded-lg bg-purple-900/30" id="chatArea">
            <div class="split"></div>
            <div id="loadingdiv"></div>
            <!-- Chat messages will appear here -->
          </div>
          <!-- <div class="processing-message" id="processingMessage">
            Processing image...
          </div> -->
          <div class="hidden items-center gap-2 px-3 py-1 my-2 bg-purple-900/30 text-white rounded-full w-fit max-w-full overflow-hidden" id="selectedFileTag">
            <span id="selectedFileName"></span>
            <span class="ml-2 cursor-pointer text-white font-bold hover:text-red-500" onclick="removeSelectedFile()">√ó</span>
          </div>
          <div class="flex gap-2 border-purple-600 border rounded-full">
            <input
              type="text"
              class="bg-transparent border-none text-white px-4 py-2 focus:outline-none w-full focus:ring-0 focus:border-transparent"
              id="messageInput"
              placeholder="Type your message..."
            />
            <button
              class="bg-purple-500 hover:bg-white text-[#0C001A] rounded-full font-bold w-8 h-8 my-auto mr-1 items-center justify-center"
              id="sendButton"
            >
              <div>ÙÄÅ∂</div>
            </button>
          </div>
          <label class="inline-flex items-center cursor-pointer mt-4 ml-2">
            <input type="checkbox" id="system-context-checkbox" name="system-context-checkbox" value="" class="sr-only peer">
            <div class="relative w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-purple-400"></div>
            <span class="ms-3 text-sm font-medium">Get System Context</span>
          </label>
        </div>
      </div>
    </div>

    <script>
      let currentPath = "/Users/nihalshah";
      let selectedFile = null;

      function updateSelectedFileTag() {
        const tag = document.getElementById("selectedFileTag");
        const fileName = document.getElementById("selectedFileName");
        if (selectedFile) {
          fileName.textContent = selectedFile.split("/").pop(); // Show only the file name
          tag.style.display = "inline-flex";
        } else {
          tag.style.display = "none";
        }
      }

      function removeSelectedFile() {
        selectedFile = null;
        updateSelectedFileTag();
        // Deselect the file in the file list
        const selectedElements = document.getElementsByClassName("selected");
        Array.from(selectedElements).forEach((element) => {
          element.classList.remove("selected");
        });
      }

      async function loadFiles(path) {
        try {
          const response = await fetch(`/files?path=${encodeURIComponent(path)}`);
          const data = await response.json();
          const fileList = document.getElementById("fileList");
          const filePreview = document.getElementById("filePreview");
          const previewContent = document.getElementById("previewContent");
          fileList.innerHTML = "";
      
          if (path !== "/Users/nihalshah") {
            const parentItem = document.createElement("div");
            parentItem.className = "file-item";
            parentItem.innerHTML = "<span class='text-purple-500 mr-2'>ÙÄàñ</span> <span class='truncate'>..</span>";
            parentItem.onclick = () => {
              const parentPath = path.split("/").slice(0, -1).join("/");
              loadFiles(parentPath || "/Users/nihalshah");
            };
            fileList.appendChild(parentItem);
          }
      
          data.forEach((item) => {
            const fileItem = document.createElement("div");
            fileItem.className = "flex items-center ml-6 p-2 rounded-lg cursor-pointer transition-colors duration-200 text-purple-100 whitespace-nowrap overflow-hidden truncate hover:bg-purple-900/30";
            const icon = item.is_directory ? "ÙÄàñ" : "ÙÄà∏";
            fileItem.innerHTML = `<span class='text-purple-500 mr-2'>${icon}</span><span class='truncate flex-1'>${item.name}</span>`;
      
            fileItem.onclick = async () => {
              if (item.is_directory) {
                loadFiles(item.path);
                return;
              }
      
              // Toggle selection
              const wasSelected = selectedFile === item.path;
              const selectedElements = document.getElementsByClassName("selected");
              Array.from(selectedElements).forEach((element) => {
                element.classList.remove("selected");
              });
      
              if (!wasSelected) {
                selectedFile = item.path;
                fileItem.classList.add("selected");
                
                // Show preview for text files
                try {
                  const response = await fetch(`/preview?path=${encodeURIComponent(item.path)}`);
                  const preview = await response.text();
                  previewContent.textContent = preview.slice(0, 500) + (preview.length > 500 ? '...' : '');
                  filePreview.classList.remove("hidden");
                } catch (error) {
                  console.error("Error loading preview:", error);
                  filePreview.classList.add("hidden");
                }
              } else {
                selectedFile = null;
                filePreview.classList.add("hidden");
              }
              
              updateSelectedFileTag();
            };
            fileList.appendChild(fileItem);
          });
        } catch (error) {
          console.error("Error loading files:", error);
        }
      }

      async function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value.trim();
        const chatArea = document.getElementById("chatArea");
        
        // Add user message
        if (message) {
          chatArea.innerHTML += `<div class="mb-2"><strong>You:</strong> ${message}</div>`;
          messageInput.value = "";
        } else if (!selectedFile) {
          return; // Don't proceed if there's no message and no file
        }
        
        // If an image is selected, show that in the chat
        if (selectedFile) {
          const fileExt = selectedFile.split('.').pop().toLowerCase();
          const isImage = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExt);
          
          if (isImage) {
            chatArea.innerHTML += `<div class="mb-2"><strong>You:</strong> [Selected image: ${selectedFile.split('/').pop()}]</div>`;
          } else {
            chatArea.innerHTML += `<div class="mb-2"><strong>You:</strong> [Selected file: ${selectedFile.split('/').pop()}]</div>`;
          }
        }
        
        chatArea.scrollTop = chatArea.scrollHeight;

        // Add loading animation - always show this when processing
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "flex items-center gap-2 mb-3";
        loadingDiv.innerHTML = `
          <div class="flex items-center gap-2">
            <div class="animate-spin animate-pulse rounded-full h-5 w-5 border-2 border-t-2 border-purple-500">
            </div>
            <span class="text-purple-300 text-sm">Processing${selectedFile ? ' your file' : ''}...</span>
          </div>
        `;
        chatArea.appendChild(loadingDiv);
        chatArea.scrollTop = chatArea.scrollHeight;

        try {
          const response = await fetch("/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              selected_file: selectedFile,
              stream: true,
              system_context: document.getElementById(
                "system-context-checkbox"
              ).checked,
            }),
          });

          // Create response div
          const responseDiv = document.createElement("div");
          responseDiv.className = "mb-3";
          responseDiv.innerHTML =
            '<strong>Assistant:</strong> <div class="markdown-content leading-6 prose prose-invert max-w-none"></div>';
          chatArea.appendChild(responseDiv);
          const contentDiv = responseDiv.querySelector(".markdown-content");
          let markdownText = ""; // Keep track of raw markdown

          // Handle streaming response
          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          while (true) {
            const { done, value } = await reader.read();
            if (done) {
              // Remove loading animation when streaming is complete
              if (loadingDiv) {
                loadingDiv.remove();
                // loadingDiv.classList.add("hidden");
              }
              break;
            }

            const chunk = decoder.decode(value);
            const lines = chunk.split("\n");

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                try {
                  const data = JSON.parse(line.slice(6));
                  if (data.event === "streaming_started") {
                    console.log("Streaming started");
                  } else if (data.response) {
                    markdownText += data.response; // Accumulate markdown text
                    contentDiv.innerHTML = marked.parse(markdownText); // Parse accumulated markdown
                    chatArea.scrollTop = chatArea.scrollHeight;
                  }
                } catch (e) {
                  console.error("Error parsing stream data:", e);
                }
              }
            }
          }
        } catch (error) {
          console.error("Error:", error);
          // Hide loader on error
          if (loadingDiv) {
            chatArea.remove(loadingDiv);
          }
          chatArea.innerHTML += `<div class="mb-2 text-red-500"><strong>Error:</strong> Failed to process request</div>`;
          chatArea.scrollTop = chatArea.scrollHeight;
        } finally {
          // Clear selected file after processing
          if (selectedFile) {
            removeSelectedFile();
          }
        }
      }

      document.getElementById("sendButton").onclick = sendMessage;
      document.getElementById("messageInput").onkeypress = (e) => {
        if (e.key === "Enter") sendMessage();
      };

      document.getElementById("searchInput").onkeyup = async (e) => {
        const searchTerm = e.target.value.trim();
        if (searchTerm) {
          const response = await fetch(
            `/search?query=${encodeURIComponent(searchTerm)}`
          );
          const data = await response.json();
          const fileList = document.getElementById("fileList");
          fileList.innerHTML = "";
          data.forEach((item) => {
            const fileItem = document.createElement("div");
            fileItem.className = "flex items-center ml-6 p-2 rounded-lg cursor-pointer transition-colors duration-200 text-purple-100 whitespace-nowrap overflow-hidden truncate hover:bg-purple-900/30";
            fileItem.innerHTML = `<span class='text-purple-500'>üìÑ</span><span class='truncate flex-1'>${item.name}</span>`;
            fileItem.onclick = () => {
              selectedFile = item.path;
              document
                .querySelectorAll(".file-item")
                .forEach((i) => i.classList.remove("selected"));
              fileItem.classList.add("selected");
              updateSelectedFileTag();
            };
            fileList.innerHTML += fileItem.outerHTML;
          });
        } else {
          loadFiles(currentPath);
        }
      };

      // Initial load
      loadFiles(currentPath);
    </script>

<script>
  document.getElementById('fileBrowserToggleOut').addEventListener('click', function() {
    const fileBrowserDrawer = document.getElementById('fileBrowserDrawer');
    const fileBrowserToggleOut = document.getElementById('fileBrowserToggleOut');
    const fileBrowserToggleIn = document.getElementById('fileBrowserToggleIn');
    fileBrowserToggleOut.classList.toggle('hidden');
    if(fileBrowserToggleIn.classList.contains('hidden')) {
      fileBrowserToggleIn.classList.remove('hidden');
    }
    if (fileBrowserDrawer) {
      if (fileBrowserDrawer.classList.contains('visible')) {
        fileBrowserDrawer.classList.remove('visible'); // Remove visible class
        setTimeout(() => {
          fileBrowserDrawer.classList.add('hidden'); // Add hidden class after animation
        }, 30); // Match this timeout with your transition duration
      } else {
        fileBrowserDrawer.classList.remove('hidden'); // Remove hidden class
        setTimeout(() => {
          fileBrowserDrawer.classList.add('visible'); // Add visible class after removing hidden
        }, 10); // Small timeout to allow the removal of hidden class to take effect
      }
    }
  });
</script>

<script>
  document.getElementById('fileBrowserToggleIn').addEventListener('click', function() {
    const fileBrowserDrawer = document.getElementById('fileBrowserDrawer');
    const fileBrowserToggleIn = document.getElementById('fileBrowserToggleIn');
    const fileBrowserToggleOut = document.getElementById('fileBrowserToggleOut');
    fileBrowserToggleOut.classList.toggle('hidden');
    fileBrowserToggleIn.classList.toggle('hidden');
    if (fileBrowserDrawer) {
      if (fileBrowserDrawer.classList.contains('hidden')) {
        fileBrowserDrawer.classList.remove('hidden'); // Remove hidden class
        setTimeout(() => {
          fileBrowserDrawer.classList.add('visible'); // Add visible class after removing hidden
        }, 10); // Small timeout to allow the removal of hidden class to take effect
      } else {
        fileBrowserDrawer.classList.remove('visible'); // Remove visible class
        setTimeout(() => {
          fileBrowserDrawer.classList.add('hidden'); // Add hidden class after animation
        }, 30); // Match this timeout with your transition duration
      }
    }
  });
</script>

    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>
  </body>
</html>
